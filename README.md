# Claude Agent Connector

A macOS desktop app that connects Slack conversations with a local Claude CLI agent.  
When a configured trigger message appears in Slack, the app runs Claude locally and posts the result back to the same thread.

## What this project solves

Claude Agent Connector helps teams keep AI-assisted execution inside their Slack workflow while still using local credentials, local tooling, and local context. It is especially useful when:

- you want a lightweight Slack-to-Claude bridge without hosting a backend service,
- you want control over local execution paths and logs,
- you prefer a native macOS utility with a menu bar presence.

## Key capabilities

- Native **SwiftUI + AppKit** macOS app (main window + menu bar status item)
- Real-time Slack event intake using **Socket Mode**
- Secure token persistence via **Keychain**
- Trigger only by **app mention** (`@YourApp`) in Slack
- Configurable channel allowlist (comma-separated channel IDs)
- Serialized task queue for predictable local execution
- Automatic threaded replies to Slack with success/failure output
- Local history and runtime logs
- Thread-level context memory: repeated mentions in same thread continue prior context
- Dedicated **@mention records** panel, separate from task history
- Tooltips and in-app quick links for token/path setup flow
- Optional macOS user notifications
- Branded app icon asset set for release builds

## Architecture at a glance

1. `SlackSocketModeClient` receives `events_api` envelopes.
2. `AppViewModel` acknowledges envelopes, filters events, and queues tasks.
3. `ClaudeAgentRunner` executes `claude -p "<prompt>"`.
4. `SlackWebAPIClient` posts the result back through `chat.postMessage`.
5. `TaskHistoryStore` + `SettingsStore` persist state locally.

Additional architecture notes: [`docs/ARCHITECTURE.md`](docs/ARCHITECTURE.md)

## Requirements

- macOS 14+
- Xcode 15+
- [XcodeGen](https://github.com/yonaskolb/XcodeGen)
- Claude CLI available on local machine (default path: `/usr/local/bin/claude`)

## Slack app configuration

Create or update your Slack app with:

- **Socket Mode** enabled
- **Event Subscriptions** enabled (for example: `app_mention`, `message.channels`)
- Bot scopes (minimum):
  - `chat:write`
  - `app_mentions:read`
  - `channels:history` (if you read channel messages)

Then collect:

- App-level token (`xapp-...`)
- Bot token (`xoxb-...`)

After changing scopes or event subscriptions, reinstall the app to your workspace so new permissions take effect.

In the app UI, each required input includes:

- inline tooltip guidance (`help`)
- direct links to relevant Slack/Claude docs
- local executable path picker for Claude binary

## Local development

```bash
brew install xcodegen
xcodegen generate --spec project.yml
open ClaudeAgentConnector.xcodeproj
```

Or build from command line:

```bash
make debug-build
```

## Build a release app

```bash
make release
```

Output:

- `dist/ClaudeAgentConnector-macOS-Release.zip`
- `dist/ClaudeAgentConnector-macOS-Release.zip.sha256`

Detailed release guide: [`docs/RELEASE.md`](docs/RELEASE.md)

## CI and release automation

- `.github/workflows/ci-macos.yml`  
  Builds the app for push/PR validation.
- `.github/workflows/release.yml`  
  Builds release packages on every push to `main` (including merged PRs) and on version tags (`v*`).
  Main-branch runs also refresh a rolling prerelease (`main-latest`) in GitHub Releases, while tag-triggered runs publish versioned releases with zip + checksum.

After each merge to `main`, download the packaged app from the **Build Release App** workflow artifact:

- `ClaudeAgentConnector-release-<ref>-<sha>`

To publish:

```bash
git tag v0.1.0
git push origin v0.1.0
```

## App icon

The repository includes a full macOS `AppIcon` set under:

- `Resources/Assets.xcassets/AppIcon.appiconset`

The icon is generated by:

- `scripts/generate_app_icon.py`

Design notes: [`docs/ICON.md`](docs/ICON.md)

## Project layout

```text
Resources/
  Assets.xcassets/
Sources/ClaudeAgentConnector/
  Models/
  Services/
  Views/
docs/
scripts/
```

## Runtime behavior and limits

- Tasks are processed sequentially by design.
- Trigger condition is mention-only: the message must mention the app user.
- Edited messages (`message_changed`) are normalized to latest text before mention matching.
- Context is tracked per `channel + thread_ts` and injected into subsequent prompts.
- If Claude execution fails, an error message is posted to Slack.
- The app is backend-free and runs fully on local machine.
- Ensure your local Claude execution environment is trusted and monitored.

## Troubleshooting: connected but no response after `@YourApp`

If the UI says connected but Slack mention does not trigger a reply, check in this order:

1. Verify Slack app settings:
   - Socket Mode is enabled.
   - Event Subscriptions are enabled and include `app_mention` (recommended) or `message.channels`.
   - Bot scopes include `app_mentions:read` and `chat:write`.
2. Reinstall the Slack app after any scope/event change.
3. Invite the app to the channel where you test mentions.
4. If channel allowlist is set, use real channel IDs (`C...`) rather than channel names.
5. Open **Runtime Logs** and **@mention records** in the app:
   - if events are received, you will see event/ignore reasons in logs;
   - if no mention record appears, Slack events are likely not reaching the app yet.
